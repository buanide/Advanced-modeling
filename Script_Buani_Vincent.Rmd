---
title: "PROJET 8: Scooter"
author: "Reau Vincent - Buani "
date: "`r Sys.Date()`"
output: pdf_document
---

```{r}
library("readxl")
d = read_excel("/home/v/r/vreau/Documents/4A/MA/mod_av_projet_scooter/scooter.xls")
#class(d)
d = as.data.frame(d)
str(d) # affiche la structure (le type) des données
```

```{r}
# préparation de données
rownames(d)<-d$ident
d<-d[,-1]
#head(d)
```

```{r}
# Transformation des types des variables
for (i in 1:6){
  d[,names(d)[i]] = as.factor(d[,names(d)[i]])
}
d$`note-satisfaction`= as.numeric(d$`note-satisfaction`)
```

```{r}
# création d'un dataframe avec uniquement les variables quantitatives
d.active = d[,7:25]
head(d.active,4)
```


```{r}
str(d)
#summary(d)
```


```{r}
stat_uni = function(x)
{
  return(c(length(na.omit(x)),
           length(x[is.na(x)]),      
           min(x, na.rm=TRUE), 
           max(x, na.rm=TRUE), 
           mean(x, na.rm=TRUE),
           median(x, na.rm=TRUE),
           sd(x, na.rm=TRUE)))
}

res_stat_uni = apply(dnum, 2, "stat_uni")
row.names(res_stat_uni) = c("Nobs", 
                            "N_manq.", 
                            "Min", 
                            "Max", 
                            "Moyenne", 
                            "Mediane", 
                            "Ecart-type")

#print(round(t(res_stat_uni),3))
knitr::kable(round(t(res_stat_uni),3), format = "markdown", align = 'r')
```

On observe que toutes les variables n'ont aucune valeurs manquantes. Pour les variables numériques toutes les impressions ont un minimum de 1 et un maximum de 5. Les moyennes sont comprises entre 3.046 et 4.469. De fait, les scores sont plutôt élevés en général. Concernant la note de satisfaction, la moyenne est de 8,2 ce qui montre que les clients sont globalement satisfait de leur scooter.

### Histogrames des variables
On retrouve bien dans les histogrammes des valeurs élevées (3,4,5) qui ont une fréquence importante.

```{r}
par(mfrow=c(2,3))
for(i in 1:ncol(dnum))
 {
 hist(dnum[,names(dnum)[i]], 
      xlab = names(dnum)[i], 
      ylab = "fréquence", 
      col = "#ffbe0b", 
      main = names(dnum)[i])  
 }
```

## Statistiques bivariées 
On nous demande de différencier les hommes des femmes pour savoir quels types de scooter offrir à l'un et à l'autre. Pour tester si les variables quantitatives d'impression changent en fonction du sexe, on réalise des boxplots avec la variable sexe mais on calcule également le rapport de corrélation entre ceux-ci.


```{r}
#install.packages('BioStatR')
library('BioStatR')
res_cor = list()
for (i in 1:ncol(d)) {
  res_cor <- append(res_cor, eta2(d[,i], d$sexe), i-1) 
}
res_cor <- as.data.frame(res_cor)
colnames(res_cor) <- names(d)
row.names(res_cor)="sexe"
knitr::kable(round(res_cor,3), format = "markdown", padding = 7, align = 'c')
```

### Boites à  moustaches
Pour démontrer la colinéarité entre une variable qualitative et une quantitative les boxplots sont utiles. Ici, on remarque que pour certaines variables, les boxplots sont disjointes ce qui indique une colinéarité entre les deux variables. On retient alors  

```{r}
par(mfrow=c(2,3))
for(i in 1:ncol(dnum))
 {
 boxplot(dnum[,names(dnum)[i]]~d[,names(d)[1]], 
         xlab = names(d)[1], 
         ylab = names(dnum)[i], 
         col = "#fcbf49")  
 }
title("Boites à  moustaches", outer=TRUE, line=-1)
```

```{r}
par(mfrow=c(2,3))
for(i in 1:ncol(dnum))
{
plot(dnum[,i], d[,1], 
     xlab = names(dnum)[i], 
     ylab = "sexe", 
     pch=16, 
     main = paste("sexe vs", names(dnum)[i]))
legend("left", paste("r = ", round(res_cor[i], 3)))
}
```

```{r}
# install.packages("Factoshiny")
#library(Factoshiny)
#Factoshiny(d)
d.active <- d.active[,-1]
str(d.active)
```

## ACP
```{r}
library(ggplot2)
library(factoextra)
library(FactoMineR)
acp.res = PCA(d, 
              scale.unit=TRUE, 
              ncp = 5,
              quanti.sup = 7,
              quali.sup = c(1:6),
              graph=FALSE)
```

```{r}
eig.val <- get_eigenvalue(acp.res)
eig.val
```

```{r}
fviz_eig(acp.res, addlabels = TRUE, ylim = c(0, 50))
```

```{r}
# Color by cos2 values: quality on the factor map
fviz_pca_var(acp.res, col.var = "contrib",
             axes = c(1,2),
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE # Avoid text overlapping
             )
fviz_pca_ind(acp.res, col.var = "contrib",
             axes = c(1,2),
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
             repel = TRUE # Avoid text overlapping
             )
```



```{r}
var <- get_pca_var(acp.res)
var
library("corrplot")
corrplot(var$contrib, is.corr=FALSE)
corrplot(var$cos2, is.corr=FALSE)

ifelse(var$contrib>5, var$contrib, 0.0)
ifelse(var$cos2>0.30, var$cos2, 0.0)
ifelse(var$contrib>5, var$coord, 0.0)

mcor <- ifelse(mcor>0.4, mcor, 0)
```

```{r}
# Contributions of variables to PC1
fviz_contrib(acp.res, choice = "var", axes = 1, top = 20)
# Contributions of variables to PC2
fviz_contrib(acp.res, choice = "var", axes = 2, top = 20)
```


```{r}
set.seed(123)
res.km <- kmeans(var$coord, centers = 3, nstart = 25)
grp <- as.factor(res.km$cluster)

fviz_pca_var(acp.res, col.var = grp, 
             palette = c("#0073C2FF", "#EFC000FF", "#868686FF"),
             legend.title = "Cluster")
```

```{r}
fviz_pca_ind(acp.res,
             geom.ind = "point", # show points only (nbut not "text")
             col.ind = d$CSP, # color by groups
             palette = c("#9b2226", "#ae2012", "#bb3e03",  "#ca6702",  "#e9d8a6",  "#0a9396"),
             addEllipses = TRUE, # Concentration ellipses
             legend.title = "Groups"
             )
```


```{r}
library("Hmisc")
rcorr(as.matrix(d.active))$P
mcor <- rcorr(as.matrix(d.active))$r
corrplot(mcor, 
         type="upper", 
         order="hclust", 
         tl.col="black", 
         #addCoef.col = T,
         #addCoefasPercent = T,
         tl.srt=55)
```


```{r}
plot.PCA(acp.res, 
         axes=c(1, 2), 
         choix="ind", 
         label="none",
         habillage=17)
```


## Analyse Factorielle des Données Mixtes (AFDM)

```{r}
library(ade4)
library(FactoMineR)
library(factoextra)
library(ggplot2)
res.famd <- FAMD(d, ncp=5, graph = FALSE)
print(res.famd)
```

```{r}
eig.val <- get_eigenvalue(res.famd)
head(eig.val)
fviz_screeplot(res.famd)
```

## Toutes les variables

```{r}
var <- get_famd_var (res.famd)
var
```

```{r}
# Coordonnées des variables
head(var$coord)
# Cos2: qualité de représentation
head(var$cos2)
# Contributions aux dimensions
head(var$contrib)
```

```{r}
# Graphique des variables
fviz_famd_var (res.famd, repel = TRUE)
# Contribution à la première dimension
fviz_contrib (res.famd, "var", axes = 1)
# Contribution à la deuxième dimension
fviz_contrib (res.famd, "var", axes = 2)
```

## Variables quantitatives

```{r}
quanti.var <- get_famd_var(res.famd, "quanti.var")
quanti.var 
```

```{r}
fviz_famd_var(res.famd, "quanti.var", repel = TRUE,
              col.var = "black")

fviz_famd_var(res.famd, "quanti.var", col.var = "contrib", 
             gradient.cols = c("#4ea8de", "#5e60ce", "#7400b8"),
             repel = TRUE)
```

http://www.sthda.com/french/articles/38-methodes-des-composantes-principales-dans-r-guide-pratique/76-afdm-analyse-factorielle-des-donnees-mixtes-avec-r-l-essentiel/

## Variables qualitatives

```{r}
quali.var <- get_famd_var(res.famd, "quali.var")
quali.var 
```


```{r}
fviz_famd_var(res.famd, "quali.var", col.var = "contrib", 
             gradient.cols = c("#4ea8de", "#5e60ce", "#7400b8")
             )
```

```{r}
fviz_famd_ind(res.famd, col.ind = "cos2", 
             gradient.cols = c("#64dfdf", "#48bfe3", "#7400b8"),
             repel = TRUE)
```

```{r}
fviz_mfa_ind(res.famd, 
             habillage = "sexe", # color by groups 
             palette = c("#9b2226", "#0a9396"),
             addEllipses = TRUE, ellipse.type = "confidence", 
             repel = TRUE # Avoid text overlapping
)
```


```{r}
fviz_mfa_ind(res.famd, 
             habillage = "âge", # color by groups 
             palette = c("#9b2226", "#ae2012", "#bb3e03",  "#ca6702",  "#e9d8a6",  "#0a9396", "#005f73"),
             addEllipses = TRUE, ellipse.type = "confidence", 
             repel = TRUE # Avoid text overlapping
)
```


```{r}
fviz_mfa_ind(res.famd, 
             habillage = "CSP", # color by groups 
             palette = c("#9b2226", "#ae2012", "#bb3e03",  "#ca6702",  "#e9d8a6",  "#0a9396"),
             addEllipses = TRUE, ellipse.type = "confidence", 
             repel = TRUE # Avoid text overlapping
             )
```


```{r}
fviz_mfa_ind(res.famd, 
             habillage = "type-cylindrée", # color by groups 
             palette = c("#00AFBB", "#E7B800", "#FC4E07", "#4f772d"),
             addEllipses = TRUE, ellipse.type = "confidence", 
             repel = TRUE # Avoid text overlapping
             )
```


```{r}
fviz_mfa_ind(res.famd, 
             habillage = "type-utilisation", # color by groups 
             palette = c("#00AFBB", "#E7B800", "#FC4E07"),
             addEllipses = TRUE, ellipse.type = "confidence", 
             repel = TRUE # Avoid text overlapping
             )
```


```{r}
fviz_mfa_ind(res.famd, 
             habillage = "critère-esthétique", # color by groups 
             palette = c("#00AFBB", "#E7B800", "#FC4E07",  "#FF4EF7",  "#0F4007",  "#0C4E07", "#F03E07"),
             addEllipses = TRUE, ellipse.type = "confidence", 
             repel = TRUE # Avoid text overlapping
             )
```


```{r}
fviz_ellipses(res.famd, c("sexe", "âge"), repel = TRUE)
fviz_ellipses(res.famd, 1:6, geom = "point")
```

## Classification hiérarchique ascendante (CAH)
http://www.sthda.com/french/articles/38-methodes-des-composantes-principales-dans-r-guide-pratique/78-classification-hierarchique-sur-composantes-principales-l-essentiel/

```{r}
res.hcpc <- HCPC(res.famd, nb.clust=5, proba=1, graph = F)
```

### Cas de variables continues
```{r}
fviz_dend(res.hcpc, 
          cex = 0.7,                     # Taille du text
          palette = "jco",               # Palette de couleur ?ggpubr::ggpar
          rect = TRUE, rect_fill = TRUE, # Rectangle autour des groupes
          rect_border = "jco",           # Couleur du rectangle
          labels_track_height = 0.8      # Augment l'espace pour le texte
          )
```

```{r}
fviz_cluster(res.hcpc,
             repel = TRUE,            # Evite le chevauchement des textes
             show.clust.cent = TRUE, # Montre le centre des clusters
             palette = "jco",         # Palette de couleurs, voir ?ggpubr::ggpar
             ggtheme = theme_minimal(),
             main = "Factor map"
             )
```

```{r}
# Principal components + tree
plot(res.hcpc, choice = "3D.map")
```

### Individus avec classement dans un cluster
```{r}
head(res.hcpc$data.clust, 10)
```
### Variables quantitatives décrivant le plus chaque cluster
```{r}
res.hcpc$desc.var$quanti
```

## Interprétation


### Axes principaux associés aux clusters
```{r}
res.hcpc$desc.axes$quanti
```
### Individus représentatif de chaque groupe
```{r}
res.hcpc$desc.ind$para
```
### Cas de variables catégorielles
```{r}
# Dendrogramme
fviz_dend(res.hcpc, show_labels = FALSE)
# Individus
fviz_cluster(res.hcpc, geom = "point", main = "Factor map")
```

```{r}
# Description par les variables
res.hcpc$desc.var$test.chi2
```

```{r}
# Description par les catégories
res.hcpc$desc.var$category
```

```{r}
res.hcpc$desc.axes
```


