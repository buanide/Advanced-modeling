---
title: "PROJET 8: Scooter"
author: "Reau Vincent - Buani "
date: "`r Sys.Date()`"
output: pdf_document
---

```{r}
library("readxl")
d = read_excel("/home/v/r/vreau/Documents/4A/MA/mod_av_projet_scooter/scooter.xls")
#class(d)
d = as.data.frame(d)
str(d) # affiche la structure (le type) des données
```

```{r}
# préparation de données
rownames(d)<-d$ident
d<-d[,-1]
#head(d)
```
```{r}
# Transformation des types des variables
for (i in 1:6){
  d[,names(d)[i]] = as.factor(d[,names(d)[i]])
}
d$`note-satisfaction`= as.numeric(d$`note-satisfaction`)
```

```{r}
# création d'un dataframe avec uniquement les variables quantitatives
dnum = d[,7:25]
```


```{r}
str(d)
#summary(d)
```


```{r}
stat_uni = function(x)
{
  return(c(length(na.omit(x)),
           length(x[is.na(x)]),      
           min(x, na.rm=TRUE), 
           max(x, na.rm=TRUE), 
           mean(x, na.rm=TRUE),
           median(x, na.rm=TRUE),
           sd(x, na.rm=TRUE)))
}

res_stat_uni = apply(dnum, 2, "stat_uni")
row.names(res_stat_uni) = c("Nobs", 
                            "N_manq.", 
                            "Min", 
                            "Max", 
                            "Moyenne", 
                            "Mediane", 
                            "Ecart-type")

#print(round(t(res_stat_uni),3))
knitr::kable(round(t(res_stat_uni),3), format = "markdown", align = 'r')
```

### Histogrames des variables
```{r}
par(mfrow=c(2,3))
for(i in 1:ncol(dnum))
 {
 hist(dnum[,names(dnum)[i]], 
      xlab = names(dnum)[i], 
      ylab = "fréquence", 
      col = "blue", 
      main = names(dnum)[i])  
 }
```

## Statistiques bivariées 
On calcul le rapport de corrélation entre la variable sexe et les variables quantitatives.
```{r}
#install.packages('BioStatR')
library('BioStatR')
res_cor = list()
for (i in 1:ncol(dnum)) {
  res_cor <- append(res_cor, eta2(dnum[,i], d$sexe), i-1) 
}
res_cor <- as.data.frame(res_cor)
colnames(res_cor) <- c("note_satisf",
                       "magasin",
                       "marque", 
                       "esthetique", 
                       "prix",
                       "confort-pilote",
                       "confort-passager",
                       "dimensions",
                       "freinage",
                       "cylindree",
                       "antivol",
                       "tableau-de-bord",
                       "accessoires",
                       "rangement",
                       "propulsion",
                       "refroidissement",
                       "tablier-avant",
                       "feux",
                       "fiabilite-moteur")
row.names(res_cor)="sexe"
knitr::kable(round(res_cor,3), format = "markdown", align = 'c')
```

### Boites à  moustaches
Pour démontrer la colinéarité entre une variable qualitative et une quantitative les boxplots sont utiles. Ici, on remarque que pour certaines variables, les boxplots sont disjointes ce qui indique une colinéarité entre les deux variables. On retient alors  

```{r}
par(mfrow=c(2,3))
for(i in 1:ncol(dnum))
 {
 boxplot(dnum[,names(dnum)[i]]~d[,names(d)[1]], 
         xlab = names(d)[1], 
         ylab = names(dnum)[i], 
         col = "green")  
 }
title("Boites à  moustaches", outer=TRUE, line=-1)
```

```{r}
par(mfrow=c(2,3))
for(i in 1:ncol(dnum))
{
plot(dnum[,i], d[,1], 
     xlab = names(dnum)[i], 
     ylab = "sexe", 
     pch=16, 
     main = paste("sexe vs", names(dnum)[i]))
legend("left", paste("r = ", round(res_cor[i], 3)))
}
```

```{r}
# install.packages("Factoshiny")
#library(Factoshiny)
#Factoshiny(d)
```

## Analyse Factorielle des Données Mixtes (AFDM)

```{r}
library(ade4)
library(FactoMineR)
library(factoextra)
library(ggplot2)
res.famd <- FAMD(d, ncp=5, graph = FALSE)
print(res.famd)
```

```{r}
eig.val <- get_eigenvalue(res.famd)
head(eig.val)
fviz_screeplot(res.famd)
```

## Toutes les variables

```{r}
var <- get_famd_var (res.famd)
var
```

```{r}
# Coordonnées des variables
head(var$coord)
# Cos2: qualité de représentation
head(var$cos2)
# Contributions aux dimensions
head(var$contrib)
```

```{r}
# Graphique des variables
fviz_famd_var (res.famd, repel = TRUE)
# Contribution à la première dimension
fviz_contrib (res.famd, "var", axes = 1)
# Contribution à la deuxième dimension
fviz_contrib (res.famd, "var", axes = 2)
```

## Variables quantitatives

```{r}
quanti.var <- get_famd_var(res.famd, "quanti.var")
quanti.var 
```

```{r}
fviz_famd_var(res.famd, "quanti.var", repel = TRUE,
              col.var = "black")

fviz_famd_var(res.famd, "quanti.var", col.var = "contrib", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)
```

http://www.sthda.com/french/articles/38-methodes-des-composantes-principales-dans-r-guide-pratique/76-afdm-analyse-factorielle-des-donnees-mixtes-avec-r-l-essentiel/

## Variables qualitatives

```{r}
quali.var <- get_famd_var(res.famd, "quali.var")
quali.var 
```


```{r}
fviz_famd_var(res.famd, "quali.var", col.var = "contrib", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07")
             )
```

```{r}
fviz_famd_ind(res.famd, col.ind = "cos2", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)
```

```{r}
fviz_mfa_ind(res.famd, 
             habillage = "sexe", # color by groups 
             palette = c("#00AFBB", "#E7B800"),
             addEllipses = TRUE, ellipse.type = "confidence", 
             repel = TRUE # Avoid text overlapping
)
```


```{r}
fviz_mfa_ind(res.famd, 
             habillage = "âge", # color by groups 
             palette = c("#00AFBB", "#E7B800", "#FC4E07",  "#FF4EF7",  "#0F4007",  "#0C4E07", "#F03E07"),
             addEllipses = TRUE, ellipse.type = "confidence", 
             repel = TRUE # Avoid text overlapping
)
```


```{r}
fviz_mfa_ind(res.famd, 
             habillage = "CSP", # color by groups 
             palette = c("#00AFBB", "#E7B800", "#FC4E07", "#FF4EF7",  "#0F4007",  "#0C4E07"),
             addEllipses = TRUE, ellipse.type = "confidence", 
             repel = TRUE # Avoid text overlapping
             )
```


```{r}
fviz_mfa_ind(res.famd, 
             habillage = "type-cylindrée", # color by groups 
             palette = c("#00AFBB", "#E7B800", "#FC4E07", "#FF4EF7"),
             addEllipses = TRUE, ellipse.type = "confidence", 
             repel = TRUE # Avoid text overlapping
             )
```


```{r}
fviz_mfa_ind(res.famd, 
             habillage = "type-utilisation", # color by groups 
             palette = c("#00AFBB", "#E7B800", "#FC4E07"),
             addEllipses = TRUE, ellipse.type = "confidence", 
             repel = TRUE # Avoid text overlapping
             )
```


```{r}
fviz_mfa_ind(res.famd, 
             habillage = "critère-esthétique", # color by groups 
             palette = c("#00AFBB", "#E7B800", "#FC4E07",  "#FF4EF7",  "#0F4007",  "#0C4E07", "#F03E07"),
             addEllipses = TRUE, ellipse.type = "confidence", 
             repel = TRUE # Avoid text overlapping
             )
```


```{r}
fviz_ellipses(res.famd, c("sexe", "âge"), repel = TRUE)
fviz_ellipses(res.famd, 1:6, geom = "point")
```

## Classification hiérarchique ascendante (CAH)
http://www.sthda.com/french/articles/38-methodes-des-composantes-principales-dans-r-guide-pratique/78-classification-hierarchique-sur-composantes-principales-l-essentiel/

```{r}
res.hcpc <- HCPC(res.famd, nb.clust=5, proba=1, graph = F)
```

### Cas de variables continues
```{r}
fviz_dend(res.hcpc, 
          cex = 0.7,                     # Taille du text
          palette = "jco",               # Palette de couleur ?ggpubr::ggpar
          rect = TRUE, rect_fill = TRUE, # Rectangle autour des groupes
          rect_border = "jco",           # Couleur du rectangle
          labels_track_height = 0.8      # Augment l'espace pour le texte
          )
```

```{r}
fviz_cluster(res.hcpc,
             repel = TRUE,            # Evite le chevauchement des textes
             show.clust.cent = TRUE, # Montre le centre des clusters
             palette = "jco",         # Palette de couleurs, voir ?ggpubr::ggpar
             ggtheme = theme_minimal(),
             main = "Factor map"
             )
```

```{r}
# Principal components + tree
plot(res.hcpc, choice = "3D.map")
```

### Individus avec classement dans un cluster
```{r}
head(res.hcpc$data.clust, 10)
```
### Variables quantitatives décrivant le plus chaque cluster
```{r}
res.hcpc$desc.var$quanti
```

## Interprétation


### Axes principaux associés aux clusters
```{r}
res.hcpc$desc.axes$quanti
```
### Individus représentatif de chaque groupe
```{r}
res.hcpc$desc.ind$para
```
### Cas de variables catégorielles
```{r}
# Dendrogramme
fviz_dend(res.hcpc, show_labels = FALSE)
# Individus
fviz_cluster(res.hcpc, geom = "point", main = "Factor map")
```

```{r}
# Description par les variables
res.hcpc$desc.var$test.chi2
```

```{r}
# Description par les catégories
res.hcpc$desc.var$category
```

```{r}
res.hcpc$desc.axes
```


